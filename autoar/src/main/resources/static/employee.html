<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>AutoAr - Jobs Calendar (Worker View)</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#135bec", "background-light": "#f6f6f8", "background-dark": "#101622" },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24 }
        .day--selected {
            background-color: #eff6ff !important;
            outline: 2px solid #135bec !important;
            border-radius: 0.5rem;
            z-index: 10;
        }
        .dark .day--selected {
            background-color: #1e293b !important;
            outline: 2px solid #3b82f6 !important;
        }
    </style>
</head>
<body class="font-display">

<div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[100] transition-all duration-500 opacity-0 translate-y-10 pointer-events-none">
    <div class="bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 border border-slate-700">
        <span class="material-symbols-outlined text-green-400">check_circle</span>
        <span id="toastMessage" class="font-medium">Task successfully taken!</span>
    </div>
</div>

<div class="relative flex h-auto min-h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-x-hidden">
    <div class="flex flex-row min-h-screen">
        <nav class="flex flex-col w-64 bg-white dark:bg-background-dark dark:border-r dark:border-slate-800 border-r border-slate-200">
            <div class="flex h-full min-h-[700px] flex-col justify-between p-4">
                <div class="flex flex-col gap-4">
                    <div class="flex gap-3 items-center px-2">
                        <div class="rounded-full size-10 flex items-center justify-center">
                            <svg class="text-primary h-12 w-12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path>
                            </svg>
                        </div>
                        <div class="flex flex-col">
                            <h1 class="text-slate-900 dark:text-white text-base font-bold leading-normal">AutoAr</h1>
                            <p class="text-slate-500 dark:text-slate-400 text-sm font-normal leading-normal">Worker Portal</p>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 pt-4">
                        <a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 text-slate-900 dark:text-white" href="#">
                            <span class="material-symbols-outlined">calendar_month</span><p class="text-sm font-medium">My Schedule</p>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-1 flex flex-col">
            <header class="flex items-center justify-between border-b border-slate-200 dark:border-slate-800 px-10 py-3 bg-white dark:bg-background-dark sticky top-0 z-20">
                <h2 class="text-lg font-bold text-slate-900 dark:text-white">Jobs Calendar</h2>
                <div class="flex gap-4">
                    <button class="flex items-center justify-center rounded-lg h-10 w-10 bg-slate-100 dark:bg-slate-800"><span class="material-symbols-outlined text-slate-600 dark:text-slate-300">notifications</span></button>
                </div>
            </header>

            <div class="flex-1 p-10">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-slate-900 dark:text-white text-3xl font-bold">Tasks Schedule</h1>
                    <div class="flex items-center gap-2">
                        <button id="prevMonthBtn" class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
                            <span class="material-symbols-outlined text-xl">chevron_left</span>
                        </button>
                        <span id="monthLabel" class="mx-2 text-slate-900 dark:text-white font-semibold text-lg text-center min-w-[11rem]"></span>
                        <button id="nextMonthBtn" class="w-9 h-9 flex items-center justify-center rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700">
                            <span class="material-symbols-outlined text-xl">chevron_right</span>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 relative">
                    <div class="lg:col-span-2">
                        <div id="calendarHeader" class="grid grid-cols-7 text-center text-sm font-semibold text-slate-600 dark:text-slate-400 mb-2">
                            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                        </div>
                        <div id="calendarGrid" class="grid grid-cols-7 border-t border-l border-slate-200 dark:border-slate-800 rounded-lg overflow-hidden">
                        </div>
                    </div>

                    <div class="relative w-full">
                        <div id="emptyStatePanel" class="bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 text-center py-20">
                            <span class="material-symbols-outlined text-5xl text-slate-300 mb-4">info</span>
                            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Task Details</h3>
                            <p class="text-slate-500 text-sm mt-2">Select a day with tasks to see the description and rewards.</p>
                        </div>

                        <div id="taskDetails" class="hidden bg-white dark:bg-slate-900 p-6 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm">
                            <div class="flex justify-between items-start">
                                <h2 class="text-lg font-bold text-slate-900 dark:text-white">Task Information</h2>
                                <button id="closeDetails" class="text-slate-400 hover:text-slate-600 text-xl">‚úï</button>
                            </div>
                            <p id="td-date" class="text-sm text-slate-500 mt-1"></p>

                            <div class="mt-6 border-t border-slate-100 dark:border-slate-700 pt-4">
                                <h3 id="td-title" class="text-xl font-bold text-slate-800 dark:text-white mb-2"></h3>
                                <p id="td-desc" class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed"></p>
                            </div>

                            <div class="mt-4 space-y-3 bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg">
                                <div class="flex justify-between"><span class="text-sm text-slate-500">Reward</span><span id="td-reward" class="text-sm font-bold text-green-600"></span></div>
                                <div class="flex justify-between"><span class="text-sm text-slate-500">Duration</span><span id="td-time" class="text-sm font-bold text-slate-700 dark:text-slate-200"></span></div>
                                <div class="flex justify-between"><span class="text-sm text-slate-500">Complexity</span><span id="td-complexity" class="text-sm font-bold text-slate-700 dark:text-slate-200"></span></div>
                            </div>

                            <div class="flex justify-between items-center mt-6">
                                <button id="prevTaskBtn" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm font-medium hover:bg-slate-200 transition-colors">‚Üê Previous</button>
                                <span id="taskIndexLabel" class="text-xs font-bold text-slate-400 uppercase tracking-wider"></span>
                                <button id="nextTaskBtn" class="px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg text-sm font-medium hover:bg-slate-200 transition-colors">Next ‚Üí</button>
                            </div>

                            <div id="workerActions" class="mt-6 hidden">
                                <button onclick="handleTakeTask()" class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg flex items-center justify-center gap-2">
                                    <span class="material-symbols-outlined">touch_app</span>
                                    Take this Job
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    let currentDate = new Date();
    let selectedDateISO = null;
    let selectedTasksList = [];
    let currentTaskIndex = 0;
    let TASKS = {};

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å (–¥–ª—è —Ç–µ—Å—Ç–∞)
    const USER_LOGIN = "worker"; // –ü–æ–º–µ–Ω—è–π—Ç–µ –Ω–∞ "boss" –¥–ª—è –≤–∏–¥–∞ –Ω–∞–Ω–∏–º–∞—Ç–µ–ª—è
    const USER_PASS = "password";
    const AUTH_HEADER = "Basic " + btoa(USER_LOGIN + ":" + USER_PASS);
    const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const msg = document.getElementById('toastMessage');
        msg.textContent = message;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
        toast.classList.remove('opacity-0', 'translate-y-10', 'pointer-events-none');
        toast.classList.add('opacity-100', 'translate-y-0');

        // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-10', 'pointer-events-none');
            toast.classList.remove('opacity-100', 'translate-y-0');
        }, 3000);
    }

    async function fetchTasks() {
        try {
            const response = await fetch('http://localhost:8080/api/tasks', {
                headers: { 'Authorization': AUTH_HEADER }
            });
            if (!response.ok) throw new Error("Auth failed");
            const data = await response.json();

            TASKS = {};
            data.forEach(task => {
                const date = task.taskDate;
                if (!TASKS[date]) TASKS[date] = [];
                TASKS[date].push(task);
            });

            renderCalendar();
            // –ï—Å–ª–∏ –º—ã –Ω–∞–Ω–∏–º–∞—Ç–µ–ª—å –∏ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏ –∑–∞–¥–∞—á—É (—ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç—Å—è –ø–æ—Å–ª–µ POST)
            // –º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å showToast("Task created successfully!");
        } catch (e) {
            console.error("Server error:", e);
        }
    }

    // --- –õ–û–ì–ò–ö–ê –í–ó–Ø–¢–ò–Ø –ó–ê–î–ê–ß–ò ---
    async function handleTakeTask() {
        const task = selectedTasksList[currentTaskIndex];
        if (!task.id) return;

        try {
            const response = await fetch(`http://localhost:8080/api/tasks/${task.id}/take`, {
                method: 'PUT',
                headers: { 'Authorization': AUTH_HEADER }
            });

            if (response.ok) {
                showToast("Task assigned to you!");
                await fetchTasks(); // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            } else {
                showToast("Error: Could not take task", true);
            }
        } catch (e) {
            showToast("Server connection error", true);
        }
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const label = document.getElementById('monthLabel');
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        label.textContent = `${MONTHS[month]} ${year}`;
        grid.innerHTML = '';

        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const firstDayIndex = new Date(year, month, 1).getDay();
        const prevMonthDays = new Date(year, month, 0).getDate();
        const totalSlots = 42;
        const startDay = prevMonthDays - firstDayIndex + 1;

        for (let i = 0; i < totalSlots; i++) {
            const cell = document.createElement('div');
            cell.className = "h-32 p-2 border-b border-r border-slate-200 dark:border-slate-800 transition-colors relative flex flex-col gap-1 overflow-hidden";

            const dayNumber = startDay + i;
            let day, isCurrentMonth;

            if (dayNumber <= prevMonthDays) {
                day = dayNumber; isCurrentMonth = false;
            } else if (dayNumber > prevMonthDays + daysInMonth) {
                day = dayNumber - (prevMonthDays + daysInMonth); isCurrentMonth = false;
            } else {
                day = dayNumber - prevMonthDays; isCurrentMonth = true;
            }

            const isoDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            if (!isCurrentMonth) {
                cell.className += " bg-slate-50/30 dark:bg-slate-900/30 cursor-default opacity-40";
            } else {
                cell.className += " cursor-pointer hover:bg-blue-50/50 dark:hover:bg-slate-800/50";
                if (selectedDateISO === isoDate) cell.classList.add('day--selected');

                cell.onclick = () => {
                    selectedDateISO = isoDate;
                    renderCalendar();
                    if (TASKS[isoDate] && TASKS[isoDate].length > 0) {
                        openTaskDetails(0);
                    } else {
                        showPanel('empty');
                    }
                };
            }

            const num = document.createElement('span');
            num.textContent = day;
            num.className = isCurrentMonth ? "text-sm font-bold text-slate-700 dark:text-slate-300" : "text-sm font-medium text-slate-300 dark:text-slate-600";
            cell.appendChild(num);

            if (isCurrentMonth && TASKS[isoDate]) {
                TASKS[isoDate].slice(0, 3).forEach((task) => {
                    const badge = document.createElement('div');

                    // –ï—Å–ª–∏ –∑–∞–¥–∞—á–∞ –≤–∑—è—Ç–∞ (TAKEN), –¥–µ–ª–∞–µ–º –µ–µ —Å–µ—Ä–æ–π
                    let colorClass = task.status === 'TAKEN' ? 'bg-slate-200 text-slate-500 opacity-50' :
                                     (task.complexity === 'High' ? 'bg-red-100 text-red-700' :
                                     task.complexity === 'Medium' ? 'bg-amber-100 text-amber-700' : 'bg-green-100 text-green-700');

                    badge.className = `text-[10px] font-bold px-1.5 py-0.5 rounded ${colorClass} truncate shadow-sm mt-0.5`;
                    badge.textContent = (task.status === 'TAKEN' ? 'üîí ' : '') + task.title;
                    cell.appendChild(badge);
                });
            }
            grid.appendChild(cell);
        }
    }

    const panels = {
        empty: document.getElementById('emptyStatePanel'),
        details: document.getElementById('taskDetails')
    };

    function showPanel(name) {
        Object.values(panels).forEach(el => el.classList.add('hidden'));
        panels[name].classList.remove('hidden');
    }

    function openTaskDetails(index) {
        if(!TASKS[selectedDateISO]) return;
        selectedTasksList = TASKS[selectedDateISO];
        currentTaskIndex = index;
        const task = selectedTasksList[index];

        document.getElementById('td-date').textContent = new Date(selectedDateISO).toLocaleDateString('en-US', { dateStyle: 'full' });
        document.getElementById('td-title').textContent = task.title;
        document.getElementById('td-desc').textContent = task.description;
        document.getElementById('td-reward').textContent = task.reward;
        document.getElementById('td-time').textContent = task.time;
        document.getElementById('td-complexity').textContent = task.complexity;
        document.getElementById('taskIndexLabel').textContent = `${index + 1} / ${selectedTasksList.length}`;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "Take Task" —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞—à–µ–ª worker –∏ –∑–∞–¥–∞—á–∞ —Å–≤–æ–±–æ–¥–Ω–∞
        const workerBtn = document.getElementById('workerActions');
        if (USER_LOGIN === "worker" && task.status === "OPEN") {
            workerBtn.classList.remove('hidden');
        } else {
            workerBtn.classList.add('hidden');
        }

        showPanel('details');
    }

    document.getElementById('prevMonthBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); };
    document.getElementById('nextMonthBtn').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); };
    document.getElementById('prevTaskBtn').onclick = () => { if(currentTaskIndex > 0) openTaskDetails(currentTaskIndex - 1); };
    document.getElementById('nextTaskBtn').onclick = () => { if(currentTaskIndex < selectedTasksList.length - 1) openTaskDetails(currentTaskIndex + 1); };
    document.getElementById('closeDetails').onclick = () => showPanel('empty');

    document.addEventListener('DOMContentLoaded', fetchTasks);
</script>

</body>
</html>